
@using System.Configuration
@using ServiceClaim.Models
@using ServiceClaim.Objects
@model ServiceClaim.Models.Claim

@{
    var serviceSheet = Model.GetLastServiceSheet();
    var zipItemList = serviceSheet.GetOrderedZipItemList();
    var causeSelList = new SelectList(ZipItemCause.GetList(), "Id", "Name");
}
<div class="row">
    <div class="col-lg-push-2 col-lg-7">
        <div>
            <h4>Редактирование ЗИП</h4>
            <table class="table table-bordered">
                <tr>
                    <td>@Html.DropDownList("cause", causeSelList, "--выберите причину--", new { @class = "form-control input-sm required-mark", required = "required" })</td>
                    <td><input id="zipIssueNewPartNum" type="text" placeholder="парт номер" class="form-control required-mark" required="required"/></td>
                    <td><input id="zipIssueNewName" type="text" placeholder="наименование" class="form-control required-mark" required="required"/></td>
                    <td>
                        <input id="zipIssueNewCount" type="text" placeholder="количество" class="form-control required-mark" required="required" value="1"/>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-success" id="addZipItem" ssid="@serviceSheet.Id"><i class="fa fa-save"></i></button>
                    </td>
                </tr>
                <tr id="zipIssueHeader" class="bg-primary" style="@(zipItemList != null && zipItemList.Any() ? String.Empty : "display: none")">
                    <th>причина</th>
                    <th>парт номер</th>
                    <th>наименование</th>
                    <th>количество</th>
                    <th></th>
                </tr>
                <tbody id="zipItemsContainer">
                    @if (zipItemList != null && zipItemList.Any())
                    {
                        foreach (var item in zipItemList)
                        {
                            <tr id="zip-item-@item.Id">
                                <td>@item.CauseName</td>
                                <td>@item.PartNum</td>
                                <td>@item.Name</td>
                                <td>@item.Count</td>
                                <td class="text-center">
                                    <a ziid="@item.Id" titel="удалить" href="#!" name="zip-item-del" class="btn btn-danger"><i class="fa fa-trash"></i></a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>

            </table>
        </div>
    </div>
</div>

@using (Html.BeginForm("ZipOrder", "Claim", FormMethod.Post, new { @id = "ZipCheckForm", role = "form" }))
{
    @Html.HiddenFor(m => m.Id)
    <div class="row">
        <div class="col-lg-push-2 col-lg-10">
            @*<a id="zipClaim"  class="btn btn-primary">Заказать ЗИП</a>*@
            <button type="submit" class="btn btn-success" value="Order" name="Order">Заказать ЗИП</button>
            @*<a class="btn btn-danger" data-toggle="modal" data-target="#modalCancel">Не нужен</a>
            <div id="modalCancel" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Rомментарий</h4>
                        </div>
                        <div class="modal-body">
                            <p>
                                @Html.TextAreaFor(m => m.Descr, new { @class = "form-control required-mark", rows = "3", placeholder = "Почему ЗИП не нужен?" })
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-default" value="Cancel" name="Cancel">Сохранить</button>
                        </div>
                    </div>
                </div>
            </div>*@
        </div>
    </div>
    <div class="row">
        <div class="col-lg-push-2 col-lg-10">
            <p class="text-danger">@TempData["error"]</p>
        </div>
    </div>
}
<script type="text/javascript">
    @*$(function () {
        $('#zipClaim').click(function () {
            var zipClaimLink = "@ConfigurationManager.AppSettings["zipClaimHost"]/Claims/Editor?snum=@Model.Device.SerialNum&ssid=@lastServSheet.Id&servid=@Model.Id&esid=@(String.IsNullOrEmpty(Model.CurEngeneerSid)? Model.CurTechSid : Model.CurEngeneerSid)&asid=@Model.CurAdminSid&csdnum=@Model.ClientSdNum&cmnt=@Url.Encode(lastServSheet.Descr)&cntr=@lastServSheet.CounterMono&cntrc=@lastServSheet.CounterColor&dvst=@lastServSheet.DeviceEnabled";
            window.open(zipClaimLink);
            $('#ZipCheckForm').submit();
        });
    });*@

    $(function() {
        $('#addZipItem').click(addZipItem);
        $('[name="zip-item-del"]').click(zipItemDelete);
    });

    function zipItemDelete() {
        if (!confirm('Вы уверены что хотите удалить ЗИП?')) return;
        var ziid = $(this).attr('ziid');
        $.ajax({
            url: '@Url.Action("ServiceSheetOrderedZipItemDelete")',
            method: 'POST',
            data: { id: ziid },
            success: function(data) {
                $('#zip-item-' + ziid).remove();
            },
            error: function(xhr, ajaxOptions, thrownError) {
                BootstrapDialog.show({
                    type: 'type-danger',
                    title: 'Ошибка!',
                    message: xhr.responseText
                });
            }
        });
    }

    function addZipItem() {
        var ssid = $(this).attr('ssid');
        var causeId = $('#cause').val();
        var causeName = $('#cause option:checked').text();
        var zipIssueNewPartNum = $('#zipIssueNewPartNum').val();
        var zipIssueNewName = $('#zipIssueNewName').val();
        var zipIssueNewCount = $('#zipIssueNewCount').val();

        if (zipIssueNewPartNum == '' || zipIssueNewName == '' || zipIssueNewCount == '') {
            BootstrapDialog.show({
                type: 'type-warning',
                title: 'Внимание!',
                message: 'Заполните все поля!'
        });
            return;
        }
        var curObj = $(this);
        showSpinnerAppend(curObj);
        $.ajax({
            url: '@Url.Action("AddServiceSheetOrderedZipItem")',
            method: 'POST',
            contentType: 'application/json;charset=utf-8 ',
            data: JSON.stringify({ PartNum: zipIssueNewPartNum, Name: zipIssueNewName, Count: zipIssueNewCount, ServiceSheetId: ssid, IdCause: causeId }),
            success: function(data) {
                if (!data.error) {
                    $('#zipIssueHeader').show();
                    var item = '<tr id="zip-item-' + data.id + '"><td>' + causeName + '</td><td>' + zipIssueNewPartNum + '</td><td>' + zipIssueNewName + '</td><td>' + zipIssueNewCount + '</td><td class="text-center"><a ziid="' + data.id + '" titel="удалить" href="#!" name="zip-item-del" class="btn btn-danger"><i class="fa fa-trash"></i></a></td></tr>';
                    $('#zipItemsContainer').prepend(item);
                    $('[name="zip-item-del"]').click(zipItemDelete);
                    $('#zipIssueNewPartNum').val('');
                    $('#zipIssueNewName').val('');
                    $('#zipIssueNewCount').val('1');
                } else {
                    BootstrapDialog.show({
                        type: 'type-warning',
                        title: 'Внимание!',
                        message: data.error
                    });
                }
                hideSpinner(curObj);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                BootstrapDialog.show({
                    type: 'type-danger',
                    title: 'Ошибка!',
                    message: xhr.responseText
                });
                hideSpinner(curObj);
            }
        });
    }
</script>
