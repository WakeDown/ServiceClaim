@using System.Linq
@using System.ServiceModel.Configuration
@using ServiceClaim.Models;
@using ServiceClaim.Objects
@{
    ViewBag.Title = "Список заявок";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var filterStates = ClaimState.GetFilterList();


}

<div class="row">
    <div class="col-lg-4">
        @Html.DropDownList("clientFilter", new SelectList(Contractor.GetServiceClaimFilterList(), "Id", "ListName", Request.QueryString["client"]), "--все клиенты--", new { @class = "form-control" })
    </div>
    @*@if (filterStates != null && filterStates.Any())
        {
            <a class="btn btn-primary" href="@Url.Action("List")">все</a>
            foreach (ClaimState st in filterStates)
            {
                <a class="btn" style="color: #@st.ForegroundColor; background-color: #@st.BackgroundColor" href="@Url.Action("List")?state=@st.Id&client=@Request.QueryString["client"]">@st.Name (@st.ClaimCount)</a>
            }
        }*@
    <div class="pull-right">Последнее обновление<div id="lastUpdateTime" class="text-danger text-center"></div></div>
</div>

<p>
    <table id="claimList" class="table table-bordered sel-list">
        <tr class="bg-primary">

            <th class="min-width">№</th>
            <th class="min-width">№ SD клиента</th>
            <th></th>
            <th>Контрагент</th>
            <th>Аппарат</th>
            <th>S/N</th>
            @*<th>Последнее изменение</th>*@
            <th></th>
            <th>Статус</th>
            @*<th>Время с момента создания</th>*@

            <th>Дата создания</th>
        </tr>
        <tbody id="claimContainer"></tbody>
    </table>
</p>


@*<div class="row">
        <blockquote class="alert-danger pull-right">
            @if (Model.TotalCount > 100)
            {
                <button name="displayRows" value="100" class="btn btn-link">показать 100</button>
            }
            @if (Model.TotalCount > 300)
            {
                <button name="displayRows" value="300" class="btn btn-link">показать 300</button>
            }
            @if (Model.TotalCount > 1000)
            {
                <button name="displayRows" value="1000" class="btn btn-link">показать 1000</button>
            }
            <button name="displayRows" value="@Model.TotalCount" class="btn btn-link">показать все</button>
            показаны @Model.List.Count() из @Model.TotalCount
        </blockquote>
    </div>*@

<script type="text/javascript">
    function fillClaimList(data) {
        var $cont = $('#claimContainer');
        $cont.find('tr').remove();

        if (data.List.length > 0) {
            for (var i = 0; i < data.List.length; i++) {
                var item = data.List[i];
                var $trItem = '<tr id="claim-' + item.Id + '" claimid="' + item.Id + '"><th class="valign-middle">' + item.Id + '</th><th class="valign-middle">' + item.ClientSdNum + '</th><td class="valign-middle"></td><td class="valign-middle">' + (item.Contractor != null ? item.Contractor.FullName : '') + '</td><td class="valign-middle">' + (item.Device != null ? item.Device.FullName : '') + '</td><td class="valign-middle">' + (item.Device != null ? item.Device.SerialNum : '') + '</td><td><div><span class="small"><span class="bold monospace">МСЦ:</span>&nbsp;' + (item.Manager != null && item.Manager.DisplayName != null ? item.Manager.DisplayName : '') + '</span></div><div><span class="small"><span class="bold monospace">&nbsp;СА:</span>&nbsp;' + (item.Admin != null && item.Admin.DisplayName != null ? item.Admin.DisplayName : '') + '</span></div><div><span class="small"><span class="bold monospace">СТП:</span>&nbsp;' + (item.Tech != null && item.Tech.DisplayName != null ? item.Tech.DisplayName : '') + '</span></div><div><span class="small"><span class="bold monospace">&nbsp;СИ:</span>&nbsp;' + (item.Engeneer != null && item.Engeneer.DisplayName != null ? item.Engeneer.DisplayName : '') + '</span></div></td><td style="background-color: #' + (item.State != null ? item.State.BackgroundColor : '') + '; color: #' + (item.State != null ? item.State.ForegroundColor : '') + '" class="valign-middle">' + (item.State != null ? item.State.Name : '') + '<div class="small">' + item.DateStateChangeStr + '-' + (item.Changer != null ? item.Changer.DisplayName : '') + '</div></td><td class="valign-middle">' + item.DateCreateStr + '</td></tr>';

                $cont.append($trItem);
            }
            initListButtons();
        }
        hideSpinner($cont);
    }

    $('[name="displayRows"]').click(function () {
        var rows = $(this).attr('value');
        reload(rows);
    });

    function reload(topRows) {
        var client = $('#clientFilter').val();
        var url = '@Url.Action("List")?client=' + client + '&state=@Request.QueryString["state"]' + '&topRows=' + topRows;
        window.location = url;
    }

    function updateListItem(claimId) {
        $.ajax({
            url: '@Url.Action("GetListItem")',
            method: 'POST',
            data: { claimId: claimId },
            success: function (html) {
                if (html != '') {
                    $('#claim-' + claimId).replaceWith(html);
                    var $tr = $('#claim-' + claimId);
                    $tr.addClass('updated');
                    initListButtons($tr);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                BootstrapDialog.show({
                    type: 'type-danger',
                    title: 'Ошибка!',
                    message: xhr.responseText
                });
            }
        });
    }

    function initListButtons($container) {
        if ($container == null) {
            $('tr[claimid]', $('#claimList')).click(function () {
                window.open('@Url.Action("Index")/' + $(this).attr('claimid'));
            });
            $container = $('#claimList');
        } else {
            $container.click(function () {
                window.open('@Url.Action("Index")/' + $(this).attr('claimid'));
            });
        }

        $('#StateEngOutWait', $container).click(function (e) {
            var $btn = $(this);
            var clid = $btn.attr('clid');
            $.ajax({
                url: '@Url.Action("StateEngOutWaitAsync", "Claim")',
                method: 'POST',
                data: { claimId: clid },
                success: function (data) {
                    showSpinnerAppend($btn);
                    updateListItem(clid);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    BootstrapDialog.show({
                        type: 'type-danger',
                        title: 'Ошибка!',
                        message: xhr.responseText
                    });
                }
            });
            e.stopPropagation();
        });
        $('#SetServEngOnWork', $container).click(function (e) {
            var $btn = $(this);
            var clid = $btn.attr('clid');
            $.ajax({
                url: '@Url.Action("SetServEngOnWorkAsync", "Claim")',
                method: 'POST',
                data: { claimId: clid },
                success: function (data) {
                    showSpinnerAppend($btn);
                    updateListItem(clid);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    BootstrapDialog.show({
                        type: 'type-danger',
                        title: 'Ошибка!',
                        message: xhr.responseText
                    });
                }
            });
            e.stopPropagation();
        });

        if ($container == null) {
            $('tr[claimid]', $container).click(function () {
                window.open('@Url.Action("Index")/' + $(this).attr('claimid'));
            });
        }
    }

    function loadClaimList() {
        showSpinnerAppend($('#claimContainer'));
        var idClient = $('#clientFilter').val();
        $.ajax({
            url: '@Url.Action("GetClaimList")',
            method: 'POST',
            data: { idClient: idClient },
            success: function (data) {
                fillClaimList(data);
                writeLastupdateTime();
                //$('#lastUpdateTime').attr('t', 0);
                
            }
        });
    }

    function writeLastupdateTime() {
        $('#lastUpdateTime').attr('dt', Date.now());
        //alert(new Date(Date.now()).toLocaleTimeString());
        var lastTime = new Date(Date.now()).toLocaleTimeString();
        $('#lastUpdateTime').html(lastTime);
    }

    //function lastUpdateTimer() {
    //    var last = $('#lastUpdateTime').attr('t');
    //    last = parseInt(last) + 1;
    //    $('#lastUpdateTime').attr('t', last);
    //        $('#lastUpdateTime').html(last + ' сек. назад');
    //}

    $(document).ready(function () {
        loadClaimList();
        //window.location.hash = 'claimList';
        $('#clientFilter').change(loadClaimList);
        setTimeout(function () { loadClaimList(); }, 60000);
        //setInterval(lastUpdateTimer, 1000);
    });
</script>


