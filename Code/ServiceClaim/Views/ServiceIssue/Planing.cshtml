@using ServiceClaim.Models

@{
    ViewBag.Title = "Планирование поездки";
    Layout = "~/Views/Shared/_Layout.cshtml";
    DateTime date = DateTime.Parse(Request.QueryString["month"]);
    int year = date.Year;
    int month = date.Month;
}

<div class="row pad-b-md">
        <div class="col-lg-3">
            <div>
                <input id="month" type="text" class="form-control" value="@String.Format("{0:MMMM yyyy}", DateTime.Now)" />
            </div>
            <div>
                @Html.DropDownList("engeneers", ServiceIssue.GetEngeneerSelectionList(), "--все инженеры--", new {@class = "form-control"})
            </div>
        </div>
    <div class="col-lg-9">
        <div class="row">
            <div class="col-lg-4">
                <span id="selectedIssueName"></span>
            </div>
            <div class="col-lg-2">
                @Html.DropDownList("selPeriod", ServiceIssue.GetPerionSelectionList(year, month), new { @class = "form-control" })
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-3">
        
        <div id="planingIssueList" class="planing-sel-list">
            @foreach (ServiceIssuePlaningItem city in ViewBag.IssueCityList)
            {
                <a class="async-sel" href="#!" name="city" cid="@city.Id">@city.IssuesCount - @city.Name</a>
                <div name="addressContainer" cid="@city.Id" class="pad-1">

                </div>
                @*foreach (ServiceIssuePlaningResult.ServiceIssuePlaningCityItem.ServiceIssuePlaningAddressItem address in city.AddressList)
                    {
                        <tr>
                            <td class="padding-sm">&nbsp;</td>
                            <td colspan="2">@address.IssuesCount - @address.Name</td>
                        </tr>
                        foreach (ServiceIssuePlaningResult.ServiceIssuePlaningCityItem.ServiceIssuePlaningAddressItem.ServiceIssuePlaningClientItem client  in address.ClientList)
                        {
                            <tr>
                                <td>&nbsp;</td>
                                <td class="padding-sm">&nbsp;</td>
                                <td>@client.IssuesCount - @client.Name</td>
                            </tr>
                        }
                    }*@
            }
        </div>
    </div>
    <div class="col-lg-9">
        <div id="issueContainer">
            <div class="row">
                <div class="col-lg-3">
                    <h4>Период 1</h4>
                </div>
                <div class="col-lg-3">
                    <h4>Период 2</h4>
                </div>
                <div class="col-lg-3">
                    <h4>Период 3</h4>
                </div>
                <div class="col-lg-3">
                    <h4>Период 4</h4>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script type="text/javascript">
        $(function() {
            $('#month').datepicker({
                minViewMode: 'months',
                orientation: 'bottom',
                format: "MM yyyy",
                autoclose: true,
                language: "ru"
            });
            $('[name="city"]').click(fillAddressList);
        });

        function fillAddressList() {
            showSpinner(this, false);
            var cid = $(this).attr('cid');
            var month = new Date($('#month').val());
            $.ajax({
                url: '@Url.Action("GetAddressList")',
                method: 'POST',
                data: { month: month, idCity: cid },
                success: function(data) {

                    if (data.length) {
                        var $container = $('[name="addressContainer"][cid="' + cid + '"]');
                        $container.html('');
                        for (var i = 0; i < data.length; i++) {
                            var address = data[i];
                            var addresItem = '<a href="#!" class="async-sel" name="address" cid="' + cid + '" aid="' + address.Name + '">' + address.IssuesCount + ' - ' + address.Name + '</a><div name="clientContainer"  cid="' + cid + '" aid="' + address.Name + '"  class="pad-2"></div>';
                            $container.append(addresItem);
                        }

                        $('[name="address"]', $container).click(fillClientList);
                    }
                    hideSpinner();
                },
                error:function(data) {
                    alert(data.error);
                    hideSpinner();
                }
            });
        }

        function fillClientList() {
            showSpinner(this, false);
            var cid = $(this).attr('cid');
            var aid = $(this).attr('aid');
            var month = new Date($('#month').val());
            $.ajax({
                url: '@Url.Action("GetClientList")',
                method: 'POST',
                data: { month: month, idCity: cid, address: aid },
                success: function(data) {
                    if (data.length) {
                        var $container = $('[name="clientContainer"][cid="' + cid + '"][aid="' + aid + '"]');
                        $container.html('');
                        for (var i = 0; i < data.length; i++) {
                            var client = data[i];
                            var clientItem = '<a href="#!" class="async-sel" name="client" cid="' + cid + '" aid="' + aid + '" clid="' + client.Id + '">' + client.IssuesCount + ' - ' + client.Name + '</a><div name="deviceContainer"  cid="' + cid + '" aid="' + aid + '"  clid="' + client.Id + '" class="pad-3"></div>';
                            $container.append(clientItem);
                        }

                        $('[name="client"]', $container).click(fillDeviceList);
                    }
                    hideSpinner();
                },
                error: function (data) {
                    alert(data.error);
                    hideSpinner();
                }
            });
        }

        function fillDeviceList() {
            showSpinner(this, false);
            var cid = $(this).attr('cid');
            var aid = $(this).attr('aid');
            var clid = $(this).attr('clid');
            var month = new Date($('#month').val());
            $.ajax({
                url: '@Url.Action("GetDeviceList")',
                method: 'POST',
                data: { month: month, idCity: cid, address: aid, idClient: clid },
                success: function(data) {
                    if (data.length) {
                        var $container = $('[name="deviceContainer"][cid="' + cid + '"][aid="' + aid + '"][clid="' + clid + '"]');
                        $container.html('');
                        for (var i = 0; i < data.length; i++) {
                            var device = data[i];
                            var deviceItem = '<div class="btn btn-link" name="device" cid="' + cid + '" aid="' + aid + '" clid="' + clid + '" did="' + device.Id + '" dname="' + device.Name + '">' + device.IssuesCount + ' - ' + device.Name + '</div>';
                            $container.append(deviceItem);
                        }

                        $('[name="device"]', $container).click(setIssue);
                    }
                    hideSpinner();
                },
                error: function (data) {
                    alert(data.error);
                    hideSpinner();
                }
            });
        }

        function setIssue() {
            showSpinner(this, false);
            var cid = $(this).attr('cid');
            var aid = $(this).attr('aid');
            var clid = $(this).attr('clid');
            var did = $(this).attr('did');
            var dname = $(this).attr('dname');
            var $issueNameInput = $('#selectedIssueName');
            $issueNameInput.text(dname);
            $issueNameInput.attr('cid', cid);
            $issueNameInput.attr('aid', aid);
            $issueNameInput.attr('clid', clid);
            $issueNameInput.attr('did', did);

            hideSpinner();
        }
    </script>
}