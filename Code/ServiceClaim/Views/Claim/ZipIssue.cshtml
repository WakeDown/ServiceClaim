@model ServiceClaim.Models.Claim
@{
    var serviceSheet = Model.GetLastServiceSheet();
    var zipItemList = serviceSheet.GetZipItemList();
    var issuedZipItemList = Model.GetIssuedZipItemList(serviceSheet.Id);//Заказанные
}

<div class="row">
    <div class="col-lg-push-2 col-lg-7">
        <div>
            
            @if (issuedZipItemList != null && issuedZipItemList.Any())
            {
                <h4>Установка ЗИП</h4>
                <table class="table table-bordered">
                    <tr class="bg-primary">
                        <th>установлено</th>
                        <th>парт номер</th>
                        <th>наименование</th>
                        <th>количество</th>
                        <th></th>
                    </tr>
                    <tbody id="issuedZipIssueItemsContainer">
                            @foreach (var item in issuedZipItemList)
                            {
                                <tr id="issued-zip-item-@item.Id" @(!item.Installed? "notinstalled=notinstalled" : String.Empty)>
                                    <td class="text-center">
                                        <button ziid="@item.Id" class="btn btn-success" name="btn-issued-zip-item-installed" style="@(item.Installed? "display: none" : String.Empty)">ДА</button>
                                    </td>
                                    <td>@item.PartNum</td>
                                    <td>@item.Name</td>
                                    <td>@item.Count</td>
                                    <td class="text-center">
                                        <button ziid="@item.Id" class="btn btn-danger" name="btn-issued-zip-item-installed-cancel" style="@(!item.Installed? "display: none" : String.Empty)">отмена</button>
                                    </td>
                                </tr>
                            }
                    </tbody>
                </table>
            }
        </div>
        <div>
            <h4>Заказ ЗИП</h4>
            <table class="table table-bordered">
                <tr>
                    <td><input id="zipIssueNewPartNum" type="text" placeholder="парт номер" class="form-control required-mark" required="required" /></td>
                    <td><input id="zipIssueNewName" type="text" placeholder="наименование" class="form-control required-mark" required="required" /></td>
                    <td>
                        <input id="zipIssueNewCount" type="text" placeholder="количество" class="form-control required-mark" required="required" value="1" />
                    </td>
                    <td>
                        <button type="submit" class="btn btn-success" id="addZipItem" ssid="@serviceSheet.Id"><i class="fa fa-save"></i></button>
                    </td>
                </tr>
                    <tr id="zipIssueHeader" class="bg-primary" style="@(zipItemList != null && zipItemList.Any() ? String.Empty: "display: none")">
                        <th>парт номер</th>
                        <th>наименование</th>
                        <th>количество</th>
                        <th></th>
                    </tr>
                    <tbody id="zipIssueItemsContainer">
@if (zipItemList != null && zipItemList.Any())
{
                        foreach (var item in zipItemList)
                        {
                            <tr id="zip-item-@item.Id">
                                <td>@item.PartNum</td>
                                <td>@item.Name</td>
                                <td>@item.Count</td>
                                <td class="text-center">
                                    <a ziid="@item.Id" titel="удалить" href="#!" name="zip-item-del"><i class="fa fa-trash"></i></a>
                                </td>
                            </tr>
                        }
}
                    </tbody>
                
            </table>
        </div>
   </div>
</div>
@using (Html.BeginForm("ZipIssue", "Claim", FormMethod.Post, new { @id = "ZipIssueForm", role = "form" }))
{
    @Html.HiddenFor(m => m.Id)
    <div class="row">
        <div class="col-lg-push-2 col-lg-10">
            <button class="btn btn-success" id="btnSendServiceSheet">Передать сервисный лист</button>
        </div>
    </div>
}
<div class="row">
    <div class="col-lg-push-2 col-lg-10">
        <p class="text-danger">@TempData["error"]</p>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        $('#addZipItem').click(addZipItem);
        $('[name="zip-item-del"]').click(zipItemDelete);
        $('[name="btn-issued-zip-item-installed"]').click(zipItemInstall);
        $('[name="btn-issued-zip-item-installed-cancel"]').click(zipItemInstallCancel);
        $('#btnSendServiceSheet').click(function() {
            var notinstalledLength =  $('[notinstalled="notinstalled"]', $('#issuedZipIssueItemsContainer')).length;
            
            if (notinstalledLength > 0) {
                if (!confirm('Остался неустановленный ЗИП - ' + notinstalledLength + ' шт. Вы уверены что хотите продолжить?')) {
                    return false;
                }
            }
            var zipNeed = @(serviceSheet.ZipClaim.HasValue && serviceSheet.ZipClaim.Value? "true":"false");
            if (zipNeed && $('#zipIssueItemsContainer tr').length <= 0) {
                if (!confirm('Вы указали что необходимо заказать ЗИП, но не указали его. Вы уверены что хотите продолжить?')) {
                return false;
            }
            }
            $('#ZipIssueForm').submit();
        });
    });

    function zipItemInstallCancel() {
        var curObj = $(this);
        showSpinnerAppend(curObj);
        var ziid = $(this).attr('ziid');
        $.ajax({
            url: '@Url.Action("ServiceSheetZipItemSetInstalledCancel")',
            method: 'POST',
            data: { id: ziid, idServiceSheet: @serviceSheet.Id },
            success: function (data) {
                $('#issued-zip-item-' + ziid).attr('notinstalled', 'notinstalled');
                $('[name="btn-issued-zip-item-installed-cancel"]', $('#issued-zip-item-' + ziid)).hide();
                $('[name="btn-issued-zip-item-installed"]', $('#issued-zip-item-' + ziid)).show();
                hideSpinner(curObj);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.responseText);
                hideSpinner(curObj);
            }
        });
    }

    function zipItemInstall() {
        var curObj = $(this);
        showSpinnerAppend(curObj);
        var ziid = $(this).attr('ziid');
        $.ajax({
            url: '@Url.Action("ServiceSheetZipItemSetInstalled")',
            method: 'POST',
            data: { id: ziid, idServiceSheet: @serviceSheet.Id },
            success: function (data) {
                $('#issued-zip-item-' + ziid).removeAttr('notinstalled');
                $('[name="btn-issued-zip-item-installed-cancel"]', $('#issued-zip-item-' + ziid)).show();
                $('[name="btn-issued-zip-item-installed"]', $('#issued-zip-item-' + ziid)).hide();
                hideSpinner(curObj);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.responseText);
                hideSpinner(curObj);
            }
        });
    }

    function zipItemDelete() {
        if (!confirm('Вы уверены что хотите удалить ЗИП?')) return;
        var ziid = $(this).attr('ziid');
        $.ajax({
            url: '@Url.Action("ServiceSheetZipItemDelete")',
            method: 'POST',
            data: { id: ziid },
            success: function (data) {
                $('#zip-item-' + ziid).remove();
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.responseText);
            }
        });
    }

    function addZipItem() {
        var ssid = $(this).attr('ssid');
        var zipIssueNewPartNum = $('#zipIssueNewPartNum').val();
        var zipIssueNewName = $('#zipIssueNewName').val();
        var zipIssueNewCount = $('#zipIssueNewCount').val();

        if (zipIssueNewPartNum == '' || zipIssueNewName == '' || zipIssueNewCount == '') {
            alert('Заполните все поля!');
            return;
        }
        var curObj = $(this);
        showSpinnerAppend(curObj);
        $.ajax({
            url: '@Url.Action("AddServiceSheetZipItem")',
            method: 'POST',
            contentType: 'application/json;charset=utf-8 ',
            data: JSON.stringify({ PartNum: zipIssueNewPartNum, Name: zipIssueNewName, Count: zipIssueNewCount, ServiceSheetId: ssid }),
            success: function (data) {
                if (!data.error) {
                    $('#zipIssueHeader').show();
                    var item = '<tr id="zip-item-' + data.id + '"><td>' + zipIssueNewPartNum + '</td><td>' + zipIssueNewName + '</td><td>' + zipIssueNewCount + '</td><td class="text-center"><a ziid="' + data.id + '" titel="удалить" href="#!" name="zip-item-del"><i class="fa fa-trash"></i></a></td></tr>';
                    $('#zipIssueItemsContainer').prepend(item);
                    $('[name="zip-item-del"]').click(zipItemDelete);
                    $('#zipIssueNewPartNum').val('');
                    $('#zipIssueNewName').val('');
                    $('#zipIssueNewCount').val('1');
                } else {
                    alert(data.error);
                }
                hideSpinner(curObj);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.responseText);
                hideSpinner(curObj);
            }
        });
    }
</script>