@model ServiceClaim.Models.Claim
@{
        var serviceSheet = Model.GetLastServiceSheet();
        var zipItemList = serviceSheet.GetZipItemList();
    }

<div class="row">
    <div class="col-lg-push-2 col-lg-7">
        <table class="table table-bordered">
            <tr>
                <td><input id="zipIssueNewPartNum" type="text" placeholder="парт номер" class="form-control required-mark" required="required" /></td>
                <td><input id="zipIssueNewName" type="text" placeholder="наименование" class="form-control required-mark" required="required" /></td>
                <td>
                    <input id="zipIssueNewCount" type="text" placeholder="количество" class="form-control required-mark" required="required" value="1" />
                </td>
                <td>
                    <button type="submit" class="btn btn-success" id="addZipItem" ssid="@serviceSheet.Id"><i class="fa fa-save"></i></button>
                </td>
            </tr>
            <tr class="bg-primary">
                <th>парт номер</th>
                <th>наименование</th>
                <th>количество</th>
                <th></th>
            </tr>
            <tbody id="zipIssueItemsContainer">
            @if (zipItemList != null && zipItemList.Any())
            {
                foreach (var item in zipItemList)
                {
                    <tr id="zip-item-@item.Id">
                        <td>@item.PartNum</td>
                        <td>@item.Name</td>
                        <td>@item.Count</td>
                        <td class="text-center">
                            <a ziid="@item.Id" titel="удалить" href="#!" name="zip-item-del"><i class="fa fa-trash"></i></a>
                        </td>
                    </tr>
                }
            }
            </tbody>
        </table>
        @*<div class="bg-warning">
            <div class="row">
                <div class="col-lg-3">
                    <input id="zipIssueNewPartNum" type="text" placeholder="парт номер" class="form-control required-mark" />
                </div>
                <div class="col-lg-5">
                    <input id="zipIssueNewName" type="text" placeholder="наименование" class="form-control required-mark" />
                </div>
                <div class="col-lg-2">
                    <input id="zipIssueNewCount" type="text" placeholder="кол-во" class="form-control required-mark" />
                </div>
                <div class="col-lg-2">
                    <button type="submit" class="btn btn-success" id="addZipItem"><i class="fa fa-save"></i></button>
                </div>
            </div>
        </div>
        <div id="zipIssueItemsContainer">
            
            <div class="row">
                <div class="col-lg-3 text-center">
                    парт номер
                </div>
                <div class="col-lg-5 text-center">
                    наименование
                </div>
                <div class="col-lg-2 text-center">
                    кол-во
                </div>
                <div class="col-lg-2">
                </div>
            </div>
        </div>*@
    </div>
</div>
@using (Html.BeginForm("ZipIssue", "Claim", FormMethod.Post, new { @id = "ZipIssueForm", role = "form" }))
{
    @Html.HiddenFor(m => m.Id)
    <div class="row">
        <div class="col-lg-push-2 col-lg-10">
            <button type="submit" class="btn btn-success">Передать сервисный лист</button>
        </div>
    </div>
}
<div class="row">
    <div class="col-lg-push-2 col-lg-10">
        <p class="text-danger">@TempData["error"]</p>
    </div>
</div>

<script type="text/javascript">
    $(function() {
        $('#addZipItem').click(addZipItem);

        $('[name="zip-item-del"]').click(zipItemDelete);
    });

    function zipItemDelete() {
        if (!confirm('Вы уверены что хотите удалить ЗИП?')) return;
        var ziid = $(this).attr('ziid');
        $.ajax({
            url: '@Url.Action("ServiceSheetZipItemDelete")',
            method: 'POST',
            data: { id: ziid },
            success: function(data) {
                $('#zip-item-' + ziid).remove();
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.responseText);
            }
        });
    }

    function addZipItem() {
        var ssid = $(this).attr('ssid');
        var zipIssueNewPartNum = $('#zipIssueNewPartNum').val();
        var zipIssueNewName = $('#zipIssueNewName').val();
        var zipIssueNewCount = $('#zipIssueNewCount').val();

        if (zipIssueNewPartNum == '' || zipIssueNewName == '' || zipIssueNewCount == '') {
            alert('Заполните все поля!');
            return;
        }

        $.ajax({
            url: '@Url.Action("AddServiceSheetZipItem")',
            method: 'POST',
            contentType: 'application/json;charset=utf-8 ',
            data: JSON.stringify({ PartNum: zipIssueNewPartNum, Name: zipIssueNewName, Count: zipIssueNewCount, ServiceSheetId: ssid }),
            success: function (data) {
                if (!data.error) {
                    var item = '<tr id="zip-item-' + data.id + '"><td>' + zipIssueNewPartNum + '</td><td>' + zipIssueNewName + '</td><td>' + zipIssueNewCount + '</td><td class="text-center"><a ziid="' + data.id + '" titel="удалить" href="#!" name="zip-item-del"><i class="fa fa-trash"></i></a></td></tr>';
                    $('#zipIssueItemsContainer').prepend(item);
                    $('[name="zip-item-del"]').click(zipItemDelete);
                    $('#zipIssueNewPartNum').val('');
                    $('#zipIssueNewName').val('');
                    $('#zipIssueNewCount').val('1');
                } else {
                    alert(data.error);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.responseText);
            }
        });
    }
</script>